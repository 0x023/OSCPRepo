<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>sc-api-functions.asm</title>
</head><body>; Shellcode functions to lookup API functions, based on The Shellcoder's Handbook http://eu.wiley.com/WileyCDA/WileyTitle/productCd-0764544683.html'<br/>
; Written for NASM assembler (http://www.nasm.us) by Didier Stevens<br/>
; https://DidierStevens.com<br/>
; Use at your own risk<br/>
;<br/>
; History:<br/>
; &nbsp; 2008/11/24: Refactored API functions to this include file<br/>
<br/>
<br/>
ARG0 equ 0x08<br/>
ARG1 equ 0x0C<br/>
ARG2 equ 0x10<br/>
ARG3 equ 0x14<br/>
<br/>
; LookupFunctions(modulehash, number of functions, hashestables, functionstable)<br/>
LookupFunctions:<br/>
&#09;push ebp<br/>
&#09;mov ebp, esp<br/>
&#09;push ecx<br/>
&#09;push esi<br/>
&#09;push edi<br/>
&#09;mov ecx, [ebp+ARG1]<br/>
&#09;mov esi, [ebp+ARG2]<br/>
&#09;mov edi, [ebp+ARG3]<br/>
loopLookupFunctions:<br/>
&#09;push dword [esi]<br/>
&#09;push dword [ebp+ARG0]<br/>
&#09;call GetFunctionAddress<br/>
&#09;mov [edi], eax<br/>
&#09;add edi, 0x04<br/>
&#09;add esi, 0x04<br/>
&#09;loop loopLookupFunctions<br/>
&#09;pop edi<br/>
&#09;pop esi<br/>
&#09;pop ecx<br/>
&#09;mov esp, ebp<br/>
&#09;pop ebp<br/>
&#09;ret 0x10<br/>
<br/>
; GetFunctionAddress(modulehash, functionhash)<br/>
; &nbsp;Return address of function with hash-value functionhash<br/>
GetFunctionAddress:<br/>
&#09;push ebp<br/>
&#09;mov ebp, esp<br/>
&#09;push ebx<br/>
&#09;push esi<br/>
&#09;push edi<br/>
&#09;push ecx<br/>
&#09;push dword [fs:0x30]<br/>
&#09;pop eax<br/>
&#09;mov eax, [eax+0x0C]<br/>
&#09;mov ecx, [eax+0x0C]<br/>
nextinlist:<br/>
&#09;mov edx, [ecx]<br/>
&#09;mov eax, [ecx+0x30]<br/>
&#09;push 0x02<br/>
&#09;mov edi, [ebp+ARG0]<br/>
&#09;push edi<br/>
&#09;push eax<br/>
&#09;call HashIt<br/>
&#09;test eax, eax<br/>
&#09;jz foundmodule<br/>
&#09;mov ecx, edx<br/>
&#09;jmp nextinlist<br/>
foundmodule:<br/>
&#09;mov eax, [ecx+0x18]<br/>
&#09;push eax<br/>
&#09;mov ebx, [eax+0x3c]<br/>
&#09;add eax, ebx<br/>
&#09;mov ebx, [eax+0x78]<br/>
&#09;pop eax<br/>
&#09;push eax<br/>
&#09;add ebx, eax<br/>
&#09;mov ecx, [ebx+0x1C]<br/>
&#09;mov edx, [ebx+0x20]<br/>
&#09;mov ebx, [ebx+0x24]<br/>
&#09;add ecx, eax<br/>
&#09;add edx, eax<br/>
&#09;add ebx, eax<br/>
find_procedure:<br/>
&#09;mov esi, [edx]<br/>
&#09;pop eax<br/>
&#09;push eax<br/>
&#09;add esi, eax<br/>
&#09;push 0x01<br/>
&#09;push dword [ebp+ARG1]<br/>
&#09;push esi<br/>
&#09;call HashIt<br/>
&#09;test eax, eax<br/>
&#09;jz found_procedure<br/>
&#09;add edx, 0x04<br/>
&#09;add ebx, 0x02<br/>
&#09;jmp find_procedure<br/>
found_procedure:<br/>
&#09;pop eax<br/>
&#09;xor edx, edx<br/>
&#09;mov dx, [ebx]<br/>
&#09;shl edx, 0x02<br/>
&#09;add ecx, edx<br/>
&#09;add eax, [ecx]<br/>
&#09;pop ecx<br/>
&#09;pop edi<br/>
&#09;pop esi<br/>
&#09;pop ebx<br/>
&#09;mov esp, ebp<br/>
&#09;pop ebp<br/>
&#09;ret 0x08<br/>
<br/>
; HashIt(string_address, hash, increment)<br/>
; &nbsp;increment: 1 for ASCII, 2 for UNICODE<br/>
; &nbsp;Return 0 if string at string_address has hash-value hash<br/>
; &nbsp;Algorithm:<br/>
; &nbsp; &nbsp;def HashIt(str):<br/>
; &nbsp; &nbsp; &nbsp; &nbsp;hash = 0<br/>
; &nbsp; &nbsp; &nbsp; &nbsp;for c in str:<br/>
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hash = (hash + (ord(c) | 0x60)) &lt;&lt; 1<br/>
; &nbsp; &nbsp; &nbsp; &nbsp;return hash<br/>
HashIt:<br/>
&#09;push ebp<br/>
&#09;mov ebp, esp<br/>
&#09;push ecx<br/>
&#09;push ebx<br/>
&#09;push edx<br/>
&#09;xor ecx, ecx<br/>
&#09;xor ebx, ebx<br/>
&#09;xor edx, edx<br/>
&#09;mov eax, [ebp+ARG0]<br/>
hashloop:<br/>
&#09;mov dl, [eax]<br/>
&#09;or dl, 0x60<br/>
&#09;add ebx, edx<br/>
&#09;shl ebx, 0x01<br/>
&#09;add eax, [ebp+ARG2]<br/>
&#09;mov cl, [eax]<br/>
&#09;test cl, cl<br/>
&#09;loopnz hashloop<br/>
&#09;xor eax, eax<br/>
&#09;mov ecx, [ebp+ARG1]<br/>
&#09;cmp ebx, ecx<br/>
&#09;jz donehash<br/>
&#09;inc eax<br/>
donehash:<br/>
&#09;pop edx<br/>
&#09;pop ebx<br/>
&#09;pop ecx<br/>
&#09;mov esp, ebp<br/>
&#09;pop ebp<br/>
&#09;ret 0x0C<br/>
<br/>
</body></html>