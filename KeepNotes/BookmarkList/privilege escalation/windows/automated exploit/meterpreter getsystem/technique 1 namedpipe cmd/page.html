<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Technique 1 NamedPipe CMD</title>
</head><body>https://github.com/rapid7/meterpreter/blob/master/source/extensions/priv/server/elevate/namedpipe.c<br/>
/*<br/>
&nbsp;* Worker thread for named pipe impersonation. Creates a named pipe and impersonates <br/>
&nbsp;* the first client which connects to it.<br/>
&nbsp;*/<br/>
Creates a named pipe for the client service to connect to:<br/>
&nbsp;&#09;hServerPipe = CreateNamedPipe( cpServicePipe, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE|PIPE_WAIT, 2, 0, 0, 0, NULL );<br/>
Wait for the client to connect to the named pipe<br/>
Read the pipe<br/>
Impersonate the client<br/>
Set the merterpreters thread token to that of the system token so all &nbsp;subsequent meterpreter threads use it<br/>
<br/>
/*<br/>
&nbsp;* Elevate from local admin to local system via Named Pipe Impersonation. We spawn a cmd.exe under local <br/>
&nbsp;* system which then connects to our named pipe and we impersonate this client. This can be done by an <br/>
&nbsp;* Administrator without the need for SeDebugPrivilege. &nbsp;Works on 2000, XP, 2003 and 2008 for all local <br/>
&nbsp;* administrators. On Vista and 7 it will only work if the host process has been elevated through UAC<br/>
&nbsp;* first. Does not work on NT4.<br/>
&nbsp;*/<br/>
Filter out Windows NT4 (not supported)<br/>
spawn cmd as SYSTEM<br/>
cmd.exe /c echo data to pipe<br/>
Start the elevator service<br/>
Impersonate SYSTEM</body></html>