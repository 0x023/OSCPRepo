<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Support Account</title>
</head><body>http://xangosec.blogspot.com/2013/06/trojanizing-windows.html <br/>
<br/>
The keys involved for these operations (changing passwords, enable/disable, etc.) are mostly in the HKLM\SAM\SAM\Domains\Account\Users key which requires SYSTEM access for write AND read access.<br/>
<br/>
As it can be seen in the image, the Names sub-key holds all user account names. Each of these account names will map to exactly one User's sub-key according to a user's RID, which is specified in hex format in the Names sub-keys void values. Once a user account is mapped to it's corresponding Users sub-key you'll find the F and V REG_BINARY values with some nice data.<br/>
<br/>
<img src="image.png" /><br/>
<br/>
<br/>
Some important data is located at offsets 30h and 38h which correspond to the user's RID and a enabled/disabled flag. Built-in accounts have well-known RIDs (see: <a href="http://technet.microsoft.com/en-us/library/cc779144%28WS.10%29.aspxhttp://technet.microsoft.com/en-us/library/cc779144%28WS.10%29.aspx">http://technet.microsoft.com/en-us/library/cc779144%28WS.10%29.aspx</a>) like the old good 500 for Administrator.<br/>
<br/>
So, what if someone was to change some of these values? Well, it happens to be that when you overwrite some user's unique RID to the one of another user (i.e. RID 500) Windows will become confused as to which user that is, and since all important OS processes read these values to do their stuff, our beloved user will share a lot of settings and info with the user who actually holds the original RID.<br/>
<br/>
As weird as it seems, once the support account is logged in it'll share the administrator's desktop, files and even shell privileges. Moreover, every operation done with this user will be seen as if it was made by the administrator in the event log. This behavior brings some advantages with it:<br/>
<ul><li>The user will be able (in many cases, depending on configuration) to log in remotely using Terminal Services, every operation will be logged as if it came from the admin account</li>
<li>You won't be viable to delete the support account, as you'd be deleting the administrator's account to the eyes of the OS xD</li>
<li>Even if it's true that quite every modification to the administrator or support account will affect both of them, some VERY important stuff won't, for example: their respective password. Such thing enables you to have access to the administrator stuff but using your own password!</li>
</ul>
<br/>
Not being enough with that, whenever an administrator (or any other user, for that purpose) checks which users are part of the administrators group (by running 'net localgroup' or alike) they won't see the support account listed. That information will only be shown to the support user itself.<br/>
<br/>
The limitations of this technique include what built-in accounts are actually in each OS versions (some built-in accounts will actually be used in the presence of Remote Assistance sessions, for example) and the fact that the target account actually appears as enabled with password set for those who look in detail.<br/>
<br/>
I wrote a metasploit post module for automating this called enable_support_account under post/windows/manage. It will actually overwrite the support_388945a0's RID for the one belonging to the administrator, enable the account and assign a password of your choice. The module has been tested and verified in WinXP and Windows server 2003 by now but it won't take much to extend it for use with other built-in accounts present in other OS versions, stay tuned. Even though, the module has the ability to change any user's RID to one you specify as there's a lot of stuff you can use with this Windows feature. <br/>
<br/>
<br/>
</body></html>