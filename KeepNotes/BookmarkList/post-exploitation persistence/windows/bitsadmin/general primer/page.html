<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body><span style="font-size: 10pt"><b>What We Want:</b><ul><li>No files left behind: binaries, vbs, ps1, batch, mof, xml... </li>
<li>Persistence across sessions and reboots</li>
<li>Functional under non-privileged user accounts</li>
<li>No need for user credentials or interaction</li>
<li>Ability to reinfect unique hosts individually </li>
<li>Self cleaning, independent of system access</li>
<li>Configurable time-based poling</li>
<li>Remotely Mutable C2 Addressing</li>
<li>C2 &amp; payload only visible during reinfection window</li>
<li>Plausibly believable configurations</li>
</ul>
<br/>
</span><span style="font-size: 10pt"><b>Shortcomings</b></span><ul>When the bitadmin /resume command is run by task scheduler, under a non-system level account, the user may see a small flash as the argument is passed to cmd.exe. This can be prevented by creating the task under a system account, or having the task only trigger on idle time.</ul>
<ul><li>The BITS job is removed automatically upon success, however, if the task is removed and the BITS job never completes, it will remain in the queue in an inactive ERROR state and will not be tried again. You can prevent this a number of ways: another task, a secondary trigger... I'll leave that practice up to you. I personally am not terribly concerned about it.</li>
</ul>
&nbsp;<span style="font-size: 10pt"><br/>
</span><span style="font-size: 10pt"><br/>
<b>Nothing is New:</b><span style="font-family: sans"><br/>
</span><span style="font-family: sans"><div style="text-align: left">Bitsadmin has received some coverage of late, most notable are the following examples.</div></span><ul><li>mubix and carnal0wnage's Derbycon2 talk: <a href="http://www.slideshare.net/mubix/windows-attacks-at-is-the-new-black-26665607">Windows Attacks AT is the new black</a></li>
<li>Mark Bagget and Jake Williams' blog post and talk: <a href="https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394">Wipe the drive! Stealthy Malware Persistence Mechanism</a> </li>
</ul>
After trying the examples listed in these talks, I realized some pieces were missing. This is not to say that the information was inaccurate, simply incomplete for my purpose. <br/>
<br/>
</span>A few steps are required:<br/>
&nbsp;1: Assemble a BITS Job<br/>
&nbsp;2: Monitor the backdoor<br/>
&nbsp;3: Priming BITS with schtasks<br/>
<br/>
<br/>
<b>A note on plausible configurations and persistence methods:</b><br/>
Some will argue that we could simply utilize this scheduled task to trigger a download and execution request at a regular interval. Perhaps pole for a powershell script. They are not incorrect, however, I prefer to leverage the innocuous appearance of the task. I am of the mind that not exposing our C&amp;C IP or Domain name in our scheduled task puts us at a lower risk of discovery; the average user, and even administrator, is highly unlikely to view the details of our BITS job. &nbsp;The curious are likely only to run common informational commands such as bitsadmin /list and bitsadmin /info, not revealing our C&amp;C information without the /verbose flag. An even more nefarious attacker might go as far as to point their C&amp;C DNS at a legitimate Windows Update server until needed, making the HTTP call back traffic appear legitimate up to and after reinfection. I certainly would never suggest doing such a thing, but yield that the more believable the configuration, the more effective the backdoor.</body></html>