<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Get-ScheduledTaskComHandler.ps1</title>
</head><body>function Get-ScheduledTaskComHandler {<br/>
&lt;#<br/>
&nbsp; &nbsp; .SYNOPSIS<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Author: Matt Nelson (@enigma0x3), Matthew Graeber (@mattifestation)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; License: BSD 3-Clause<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Required Dependencies: None<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Optional Dependencies: None<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Checks all scheduled tasks that execute on user logon &amp; have a "Custom handler" set. This will expose<br/>
&nbsp; &nbsp; &nbsp; &nbsp; tasks that are able to be abused for userland persistence via COM handler hijacking.<br/>
<br/>
&nbsp; &nbsp; .EXAMPLE<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; PS C:\&gt; Get-ScheduledTaskComHandler<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Return all scheduled tasks with COM handlers.<br/>
<br/>
&nbsp; &nbsp; .PARAMETER OnLogon<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Shows all Tasks that start on logon &amp; associated CLSIDS/DLLs <br/>
<br/>
&nbsp; &nbsp; .PARAMETER PersistenceLocations<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Shows all Tasks that are able to be Hijacked for userland persistence.<br/>
<br/>
#&gt;<br/>
<br/>
<br/>
[CmdletBinding(DefaultParameterSetName = 'OnLogon')]<br/>
param(<br/>
&nbsp; &nbsp; [Parameter(ParameterSetName = 'OnLogon')]<br/>
&nbsp; &nbsp; [Switch]<br/>
&nbsp; &nbsp; $OnLogon,<br/>
&nbsp; &nbsp; [Parameter(ParameterSetName = 'PersistenceLocations')]<br/>
&nbsp; &nbsp; [Switch]<br/>
&nbsp; &nbsp; $PersistenceLocations<br/>
<br/>
)<br/>
<br/>
&nbsp; &nbsp; $ErrorActionPreference = "SilentlyContinue"<br/>
&nbsp; &nbsp; $Path = "$($ENV:windir)\System32\Tasks"<br/>
&nbsp; &nbsp; $null = New-PSDrive -PSProvider registry -root HKEY_CLASSES_ROOT -Name HKCR<br/>
&nbsp; &nbsp; Get-ChildItem -Path $Path -Recurse | Where-Object { ! $_.PSIsContainer } | ForEach-Object {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $TaskName = $_.Name<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $TaskXML = [xml] (Get-Content $_.FullName)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if($TaskXML.Task.Actions.ComHandler) { &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $TaskTrigger = $TaskXML.Task.Triggers.OuterXML<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $TaskXML.Task.Actions.Exec.Command| ForEach-Object {<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $COM = $TaskXML.Task.Actions.ComHandler.ClassID<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $dll = (Get-ItemProperty -LiteralPath HKCR:\CLSID\$COM\InprocServer32).'(default)'<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out = New-Object PSObject<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out | Add-Member Noteproperty 'TaskName' $TaskName<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out | Add-Member Noteproperty 'CLSID' $COM<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out | Add-Member Noteproperty 'Dll' $dll<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out | Add-Member Noteproperty 'Logon' $False<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $null = $TaskXML.Task.InnerXml -match 'Context="(?&lt;Context&gt;InteractiveUsers|AllUsers|AnyUser)"'<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $IsUserContext = $False<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($Matches['Context']) { $IsUserContext = $True }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out | Add-Member Noteproperty 'IsUserContext' $IsUserContext<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if($TaskTrigger.Contains('LogonTrigger')){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out.Logon = $True<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else{$Out.Logon = $False}<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Context = $null<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if($OnLogon){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($Out.Logon) {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } elseif($PersistenceLocations){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($Out.IsUserContext -and $Out.Logon -eq "True") {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $Out<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else { $Out } &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; }<br/>
}<br/>
</body></html>