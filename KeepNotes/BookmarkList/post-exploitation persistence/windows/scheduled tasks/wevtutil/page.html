<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Wevtutil</title>
</head><body>If you need a more fine grained approach you can trigger tasks on highly specific Windows events. Doing so is a bit more labour intensive but it gives you unparalleled control over you task execution. The only caveat is that the target needs to have event logging enable for the event you want to target. You can piggyback the existing event loggers, but there does not seem to be a straight forward way to add custom events from the command line (it may be possible to import a custom event manifest but I have not tested this). If you have GUI access, custom events can be configured using gpedit.msc. A more detailed explanation can be found <a href="http://superuser.com/questions/538146/run-a-batch-cmd-upon-screensaver/538849">here</a>.<br/>
<br/>
<br/>
We can check the last recorded "User initiated Logoff" event by referencing the event channel (Security) and the event ID (4647).<br/>
C:\Windows\system32&gt; wevtutil qe Security /f:text /c:1 /q:"Event[System[(EventID=4647)]]<br/>
<br/>
Event[0]:<br/>
&nbsp; Log Name: Security<br/>
&nbsp; Source: Microsoft-Windows-Security-Auditing<br/>
&nbsp; Date: 2014-09-13T21:05:54.339<br/>
&nbsp; Event ID: 4647<br/>
&nbsp; Task: Logoff<br/>
&nbsp; Level: Information<br/>
&nbsp; Opcode: Info<br/>
&nbsp; Keyword: Audit Success<br/>
&nbsp; User: N/A<br/>
&nbsp; User Name: N/A<br/>
&nbsp; Computer: Win7-Testbed<br/>
&nbsp; Description:<br/>
User initiated logoff:<br/>
<br/>
Subject:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Security ID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;S-1-5-21-2436999474-2994553960-2820488997-1001<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Name: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fubar<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Account Domain: &nbsp; &nbsp; &nbsp; &nbsp; Win7-Testbed<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Logon ID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x14afc<br/>
<br/>
<br/>
<br/>
With this information in hand we can create a scheduled task. We will need to provide schtasks with the appropriate event channel and the XPath query string for the target event<br/>
C:\Windows\system32&gt; schtasks /Create /TN OnLogOff /TR C:\Windows\system32\calc.exe /SC ONEVENT /EC<br/>
Security /MO "*[System[(Level=4 or Level=0) and (EventID=4634)]]"<br/>
<br/>
SUCCESS: The scheduled task "OnLogOff" has successfully been created.<br/>
<br/>
C:\Windows\system32&gt; schtasks /Query /tn OnLogOff /fo List /v<br/>
<br/>
Folder: \<br/>
HostName: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;WIN7-TESTBED<br/>
TaskName: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;\OnLogOff<br/>
Next Run Time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Status: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;Ready<br/>
Logon Mode: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;Interactive only<br/>
Last Run Time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;N/A<br/>
Last Result: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;1<br/>
Author: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;Fubar<br/>
Task To Run: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;C:\Windows\system32\calc.exe<br/>
Start In: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Comment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;N/A<br/>
Scheduled Task State: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Enabled<br/>
Idle Time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;Disabled<br/>
Power Management: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Stop On Battery Mode, No Start On Batteries<br/>
Run As User: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;Win7-Testbed\Fubar<br/>
Delete Task If Not Rescheduled: &nbsp; &nbsp; &nbsp; Enabled<br/>
Stop Task If Runs X Hours and X Mins: 72:00:00<br/>
Schedule: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;Scheduling data is not available in this format.<br/>
Schedule Type: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;When an event occurs<br/>
Start Time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Start Date: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
End Date: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Days: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Months: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;N/A<br/>
Repeat: Every: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;N/A<br/>
Repeat: Until: Time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;N/A<br/>
Repeat: Until: Duration: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N/A<br/>
Repeat: Stop If Still Running: &nbsp; &nbsp; &nbsp;N/A<br/>
</body></html>