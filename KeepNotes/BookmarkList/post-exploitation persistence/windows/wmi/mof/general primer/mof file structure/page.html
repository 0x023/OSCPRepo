<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>MOF File Structure</title>
</head><body>Premise:<br/>
A MOF file must consist of (at least) the following three components: <br/>
an __EventFilter which uses the WMI Query Language (WQL) to detect a specific event, <br/>
an Event Consumer Class which defines a certain action and <br/>
a __FilterToConsumerBinding which binds an event and an action together. <br/>
<br/>
<br/>
<b>__EventFilter:</b><br/>
The event filter class is used to hook/detect specific operating system events defined by a WQL statement. The basic structure of an event filter can be seen below.<br/>
<br/>
instance of __EventFilter as $EventFilter<br/>
{<br/>
&nbsp; &nbsp; Name &nbsp;= "Event Filter Name"; &nbsp; &nbsp; &#09;&#09;# Unique event name.<br/>
&nbsp; &nbsp; EventNamespace = "Root\\Cimv2"; &nbsp;&#09;# Namespace for event instance.<br/>
&nbsp; &nbsp; Query = "WQL-Query"; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#09;&#09;# WQL event query.<br/>
&nbsp; &nbsp; QueryLanguage = "WQL"; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#09;&#09;# Only WQL is currently supported.<br/>
};<br/>
<br/>
Using WQL almost any hardware or operating system event can be set as and event trigger. I highly recommend that you take some time to review the Win32 Provider Classes to get an understanding of the scope of these events. As always, the best way to learn is to try to formulate some queries on your local host. In powershell the Get-WmiObject cmdlet can be used, in conjunction with the provided link, to get instances of WMI classes.<br/>
<br/>
<br/>
<b>Event Consumer Class:</b><br/>
The two most interesting consumer classes are: <br/>
(1) The ActiveScriptEventConsumer class which allows us to execute VBS payloads and <br/>
(2) the CommandLineEventConsumer class which we can use to execute terminal commands. <br/>
Both classes have a really basic structure, examples of both can be seen below. Keep in mind that any payload executed by the consumer class will run as SYSTEM.<br/>
<br/>
# VBS payload.<br/>
instance of ActiveScriptEventConsumer as $consumer &nbsp;<br/>
{ &nbsp;<br/>
&nbsp; &nbsp; Name = "Event Consumer Name"; &nbsp;<br/>
&nbsp; &nbsp; ScriptingEngine = "VBScript"; &nbsp;<br/>
&nbsp; &nbsp; ScriptText = "VBS Payload!"; &nbsp;<br/>
};<br/>
<br/>
# Command line payload.<br/>
instance of CommandLineEventConsumer as $consumer<br/>
{<br/>
&nbsp; &nbsp; Name = "Event Consumer Name";<br/>
&nbsp; &nbsp; RunInteractively = false;<br/>
&nbsp; &nbsp; CommandLineTemplate = "CMD Payload!";<br/>
};<br/>
<br/>
Using these two payload types any desired action can be performed; killing processes/services, creating and executing scripts, installing software/drivers, injecting shellcode, etc.<br/>
<br/>
<br/>
<b>__FilterToConsumerBinding:</b><br/>
This class is also very straight forward, all we really need to know is that it binds an event trigger to an event consumer. An example can be seen below.<br/>
<br/>
instance of __FilterToConsumerBinding<br/>
{<br/>
&#09;Filter = $filter; &nbsp; &nbsp; &nbsp;# Our WQL event trigger.<br/>
&#09;Consumer = $consumer; &nbsp;# Our event consumer payload.<br/>
}; <br/>
<br/>
Multiple instances of __FilterToConsumerBinding can be defined in a single MOF. An event filer can be linked to multiple consumers and a consumer can be linked to multiple event filters.<br/>
</body></html>