<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Mitigation</title>
</head><body>Domain Controller Security Events When Implanting the Mimikatz Skeleton Key:<br/>
<br/>
When implanting the skeleton key remotely using Mimikatz the following events are logged on the Domain Controller.<br/>
Event Id 4673 Sensitive Privilege Use,<br/>
Event 4611: A trusted logon process has been registered with the Local Security Authority.<br/>
<br/>
If Process Tracking (logging) is enabled, there are two events that are logged reliably.<br/>
<br/>
Event 4688: A new process has been created.<br/>
Event 4689: A new process has exited.<br/>
<br/>
<br/>
Skeleton Key Mitigation:<br/>
<br/>
&nbsp; &nbsp; Protect domain-level admin (DLA) accounts (Domain Admin, Administrators, etc) which reduces the risk of attackers gaining access to these credentials. Don’t let DLA accounts logon to systems at a different security level from Domain Controllers. Don’t let services run as Domain Admin on member servers that aren’t protected at the same level as DCs.<br/>
&nbsp; &nbsp; Enable smart card authentication for all users.<br/>
&nbsp; &nbsp; Ensure Domain Controllers have limited connectivity to the network until MS14-068 is patched (kb3011780). The challenge is that the patch has to be applied after DCPromo is complete.<br/>
&nbsp; &nbsp; Security software that prevents LSASS patching may mitigate the issue.<br/>
&nbsp; &nbsp; Application whitelisting (ex. AppLocker) can prevent unapproved applications from running on Domain Controllers.<br/>
&nbsp; &nbsp; Enabling Process Logging on Domain Controllers provides additional data on what applications (exes) are executed on Domain Controllers.<br/>
&nbsp; &nbsp; Enable LSASS as a protected process on Windows Server 2012 R2 (Mimikatz can bypass with a driver, but that should make some noise in the event logs):<br/>
<br/>
&nbsp; &nbsp; The LSA, which includes the Local Security Authority Server Service (LSASS) process, validates users for local and remote sign-ins and enforces local security policies. The Windows 8.1 operating system provides additional protection for the LSA to prevent reading memory and code injection by non-protected processes. This provides added security for the credentials that the LSA stores and manages.<br/>
<br/>
<br/>
To enable LSA protection on a single computer<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Open the Registry Editor (RegEdit.exe), and navigate to the registry key that is located at: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Set the value of the registry key to: “RunAsPPL”=dword:00000001.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Restart the computer.<br/>
<br/>
To enable LSA protection using Group Policy<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Open the Group Policy Management Console (GPMC).<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Create a new GPO that is linked at the domain level or that is linked to the organizational unit that contains your computer accounts. Or you can select a GPO that is already deployed.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Right-click the GPO, and then click Edit to open the Group Policy Management Editor.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Expand Computer Configuration, expand Preferences, and then expand Windows Settings.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Right-click Registry, point to New, and then click Registry Item. The New Registry Properties dialog box appears.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; In the Hive list, click HKEY_LOCAL_MACHINE.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; In the Key Path list, browse to SYSTEM\CurrentControlSet\Control\Lsa.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; In the Value name box, type RunAsPPL.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; In the Value type box, click the REG_DWORD.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; In the Value data box, type 00000001.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Click OK.<br/>
<br/>
Not that with privilege::debug and !+, !processprotect /process:lsass.exe /remove, Mimikatz can bypass lsass protection</body></html>