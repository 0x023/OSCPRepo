<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body>ADS can be used to hide data (dir command without the /r switch will not display them; explorer.exe will also not show them; We will later see how we can even hide from the /r dir switch…)<br/>
<br/>
ADS has another great property – we can add an ADS to a folder. To be allowed to do this we must own the “create folders” permissions on the directory (and the folder name must not be a number). The important fact is that an ADS on a folder looks like a file from the parent folder!<br/>
<br/>
For example, consider that an application allows to upload data and that uploaded data is stored in applicationFolder\uploadedData\. Moreover, the application allows to start scripts / applications from applicationFolder\ but not from applicationFolder\uploadedData\ (with a blacklist approach). If the user uploads a file named “:foo.ps1″, the system will create an ADS like applicationFolder\uploadedData:foo.ps1 and this file appears to be stored inside applicationFolder\ and therefore bypassing the security checks.<br/>
<br/>
Another interesting fact is that ADS names can contain symbols which are normally forbidden for filenames like ” or * (you have to create these files using the native Windows API; cmd.exe filteres these characters):<br/>
<img src="image.png" /><br/>
This on it’s own can lead to several problems (e.g.: if the filename ends with ” and the path is enclosed by ”)<br/>
<br/>
<br/>
<br/>
Basically, the syntax required to access a NTFS stream is the following:<br/>
<br/>
&lt;name&gt;:&lt;stream_name&gt;:&lt;stream_type&gt;<br/>
<ul><li>name refers the the resource, it can be a file (e.g. document.txt) or a folder (e.g. Windows)</li>
<li>stream_name is the name of our compartment, when working with files, an empty stream name indicates the default stream, when dealing with folders, the default stream name will be “$I30″</li>
<li>stream_type will be always $DATA when dealing with files or $INDEX_ALLOCATION for folders</li>
</ul>
<br/>
When the stream_name is omitted, you are accessing the main stream. For example, the following NTFS streams are equivalent:<br/>
<ul><li>myfile.txt</li>
<li>myfile.txt:</li>
<li>myfile.txt::$DATA</li>
</ul>
<br/>
In the case of directories, the following NTFS streams are equivalent:<br/>
<ul><li>mydir</li>
<li>mydir:$I30:$INDEX_ALLOCATION</li>
<li>mydir::$INDEX_ALLOCATION</li>
</ul>
<br/>
<br/>
<br/>
How to create ADS<br/>
echo "test" &gt; myfile:stream<br/>
mkdir "myfolder:$I30:$INDEX_ALLOCATION"<br/>
<br/>
How to read ADS<br/>
more &lt; myfile:stream<br/>
more &lt; myfile:stream:$DATA<br/>
dir C:\Windows:$I30:$INDEX_ALLOCATION<br/>
<br/>
How can I enumerate NTFS data streams on Windows?<br/>
<br/>
Powershell<br/>
get-item -Path d:\* -Stream *<br/>
<br/>
Vista and above<br/>
dir /r<br/>
<br/>
Sysinternals<br/>
streams -s c:<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</body></html>