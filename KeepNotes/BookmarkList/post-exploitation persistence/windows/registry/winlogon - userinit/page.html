<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>WinLogon / Userinit</title>
</head><body>&nbsp;the Userinit registry key defines which programs are run by Winlogon when a user logs in to the system. Typically Winlogon runs Userinit.exe, which in turn runs logon scripts, reestablishes network connections, and then starts explorer.<br/>
<br/>
Below we can see the "default" content for the Winlogon registry key.<br/>
<br/>
# Windows 7 machine.&#09;<br/>
C:\Windows\system32&gt; reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"<br/>
<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon<br/>
&nbsp; &nbsp; ReportBootOk &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;1<br/>
&nbsp; &nbsp; Shell &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;explorer.exe<br/>
&nbsp; &nbsp; PreCreateKnownFolders &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;{A520A1A4-1780-4FF6-BD18-167343C5AF16}<br/>
&nbsp; &nbsp; Userinit &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;C:\Windows\system32\userinit.exe<br/>
&nbsp; &nbsp; VMApplet &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;SystemPropertiesPerformance.exe /pagefile<br/>
&nbsp; &nbsp; AutoRestartShell &nbsp; &nbsp;REG_DWORD &nbsp; &nbsp;0x1<br/>
&nbsp; &nbsp; Background &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0 0 0<br/>
&nbsp; &nbsp; CachedLogonsCount &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;10<br/>
&nbsp; &nbsp; DebugServerCommand &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;no<br/>
&nbsp; &nbsp; ForceUnlockLogon &nbsp; &nbsp;REG_DWORD &nbsp; &nbsp;0x0<br/>
&nbsp; &nbsp; LegalNoticeCaption &nbsp; &nbsp;REG_SZ<br/>
&nbsp; &nbsp; LegalNoticeText &nbsp; &nbsp;REG_SZ<br/>
&nbsp; &nbsp; PasswordExpiryWarning &nbsp; &nbsp;REG_DWORD &nbsp; &nbsp;0x5<br/>
&nbsp; &nbsp; PowerdownAfterShutdown &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0<br/>
&nbsp; &nbsp; ShutdownWithoutLogon &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0<br/>
&nbsp; &nbsp; WinStationsDisabled &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0<br/>
&nbsp; &nbsp; DisableCAD &nbsp; &nbsp;REG_DWORD &nbsp; &nbsp;0x1<br/>
&nbsp; &nbsp; scremoveoption &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0<br/>
&nbsp; &nbsp; ShutdownFlags &nbsp; &nbsp;REG_DWORD &nbsp; &nbsp;0x5<br/>
&nbsp; &nbsp; AutoAdminLogon &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;0<br/>
&nbsp; &nbsp; DefaultUserName &nbsp; &nbsp;REG_SZ &nbsp; &nbsp;Fubar<br/>
<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\AutoLogonChecked<br/>
<br/>
There is (almost) no legitimate reason to modify the "Userinit" registry key so if you ever encounter a non-default value here you should hear alarm bells going off. As it turns out we can simply modify the key and prepend the userinit.exe executable with our own malicious binary/script<br/>
<br/>
C:\Windows\system32&gt; reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v Userinit<br/>
/t REG_SZ /d "C:\Some\Evil\Binary.exe","C:\Windows\system32\userinit.exe"<br/>
<br/>
Value Userinit exists, overwrite(Yes/No)? Yes<br/>
The operation completed successfully.<br/>
<br/>
<br/>
With the modification shown above any user login will trigger the execution of our evil "Binary.exe". This is definitely pretty obtrusive. For stealth purposes it would be much better to backdoor the userinit executable or rename it and load a different binary (with the same name) that has an epilog which calls the original executable.</body></html>