<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Autorun Directories</title>
</head><body><a href="https://blog.cylance.com/windows-registry-persistence-part-2-the-run-keys-and-search-order.html">The GuideBook for Registry Persistence</a>&nbsp;<br/>
<br/>
Windows NT 9.0 - 10.0 &#09;&#09;&#09;C:\Windows\Start Menu\Programs\Startup<br/>
Windows NT 6.0 - 10.0 / All Users&#09;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup<br/>
Windows NT 6.0 - 10.0 / Current User&#09;C:\Users\%UserName%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup<br/>
Windows NT 5.0 - 5.2&#09;&#09;&#09;C:\Documents and Settings\All Users\Start Menu\Programs\Startup<br/>
Windows NT 3.5 - 4.0&#09;&#09;&#09;C:\WINNT\Profiles\All Users\Start Menu\Programs\Startup<br/>
<br/>
Shortcut links (.lnk) placed in these folders will cause Windows to launch each time &lt;user&gt; logs into Windows.<br/>
<br/>
The registry run keys perform the same action, but can be located in four different locations:<br/>
<br/>
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run<br/>
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run<br/>
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce<br/>
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce<br/>
<br/>
<br/>
Adding a bat script to HKEY_CURRENT_USER\Software\Microsoft\Command Processor will execute this script using cmd.exe upon reboot.<br/>
<br/>
1) &nbsp;HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\BootExecute <br/>
2) &nbsp;HKLM\System\CurrentControlSet\Services &nbsp;(start value of 0 indicates kernel drivers, which load before kernel initiation) <br/>
3) &nbsp;HKLM\System\CurrentControlSet\Services (start value of 2, auto-start and 3, manual start via SCM) <br/>
4) &nbsp;HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce <br/>
5) &nbsp;HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce <br/>
6) &nbsp;HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices <br/>
7) &nbsp;HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices <br/>
8) &nbsp;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify <br/>
9) &nbsp;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit <br/>
10) HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\\Shell <br/>
11) HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\\Shell <br/>
12) HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\ShellServiceObjectDelayLoad <br/>
13) HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce <br/>
14) HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnceEx <br/>
15) HKLM\Software\Microsoft\Windows\CurrentVersion\Run <br/>
16) HKCU\Software\Microsoft\Windows\CurrentVersion\Run <br/>
17) HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce <br/>
18) HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run <br/>
19) HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run <br/>
20) HKCU\Software\Microsoft\Windows NT\CurrentVersion\Windows\load <br/>
21) HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows <br/>
22) HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\SharedTaskScheduler (XP, NT, W2k only) <br/>
23) HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows\\AppInit_DLLs<br/>
<br/>
Note: Some of these keys are also reflected under HKLM\Software\wow6432node on systems running on a 64bit architecture and with a 64bit version of Windows. I wonâ€™t be covering each of these in this post.<br/>
<br/>
Startup folders<br/>
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders<br/>
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders<br/>
<br/>
BootExecute Key<br/>
Since smss.exe launches before windows subsystem loads, it calls configuration subsystem to load the hive present at HKLM\SYSTEM\CurrentControlSet\Control\hivelist. Also smss.exe will launch anything present in the BootExecute key at HKEY_LOCAL_MACHINE\SYSTEM\ControlSet002\Control\Session Manager. It should always have the value of autocheck autochk*. If there are more values in it, then probably the malware is likely to launch at boot. (source)<br/>
<br/>
UserInit keys:<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\UserInit<br/>
<br/>
Notify:<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify<br/>
<br/>
Explorer.exe<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell, this key points to explorer.exe(Windows interface) and should only be string explorer.exe rather than complete path as it is supposed to launch from \windows. The boot key at HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\IniFileMapping\system.ini\boot points to the location under Winlogon only. (same source)<br/>
<br/>
Services (runs as system / stealthy / safe):<br/>
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services<br/>
<br/>
Plus services that fail to start can be set to run a program instead<br/>
Dropping a dll in SVCHost is a bit more complicated, please read the <a href="https://blog.cylance.com/windows-registry-persistence-part-1-introduction-attack-phases-and-windows-services">post</a>&nbsp;for a walkthrough <br/>
HKLM\Software\Microsoft\Windows NT\CurrentVersion\SvcHost<br/>
<br/>
Browser helper objects BHO<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects<br/>
<br/>
AppInit DLLs<br/>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs<br/>
<br/>
File association keys<br/>
HKEY_LOCAL_MACHINE\Software\Classes\ and HKEY_CLASSES_ROOT\;<br/>
<br/>
Other registry keys such as<br/>
Autoruns for XP SP3:<br/>
<br/>
<a href="http://trustedsignal.com/IR/XPSP3_HKCU_Startup_Locations.txt">XPSP3_HKCU_Startup_Locations.txt</a><br/>
<a href="http://trustedsignal.com/IR/XPSP3_HKLM_Startup_Locations.txt">XPSP3_HKLM_Startup_Locations.txt</a><br/>
<br/>
source: <a href="https://digital-forensics.sans.org/blog/2010/10/20/digital-forensics-autorun-registry-keys/">https://digital-forensics.sans.org/blog/2010/10/20/digital-forensics-autorun-registry-keys/</a>&nbsp;<br/>
<br/>
<br/>
Scheduled tasks:<br/>
C:\Windows\System32\Tasks<br/>
<br/>
HKLM\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\SCHEDULE\TASKCACHE\TASKS\<br/>
HKLM\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\SCHEDULE\TASKCACHE\TREE\<br/>
<br/>
<br/>
<br/>
<br/>
See Cheet Sheets and Syntax &gt; Local enumeration &gt; Windows &gt; Registry Cheet Sheet &gt; <a href="nbk:///ddc1e41d-c438-4bf2-93b2-d9c23685146b">AutoRun / Persistence</a>&nbsp;for Reg Keys<br/>
<br/>
</body></html>